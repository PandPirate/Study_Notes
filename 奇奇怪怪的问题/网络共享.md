# 网络共享
##
- 问题
pc 笔记本两台电脑，只有一条网线到外网
- 目的
使笔记本具有路由功能，pc作为连在子网
```

                ┌──────────────────────────┐
                │        互联网 / ISP      │
                └───────────▲─────────────┘
                            │  (公网 / 上游私网)
                            │
                      (WAN) │ eno1
                            │  DHCP: 192.168.31.189/24
                            │  GW:   192.168.31.1
                            │
                  ┌─────────┴─────────┐
                  │  Arch Linux 网关  │  systemd-networkd + nftables
                  │  作为路由/NAT     │
                  │  net.ipv4.ip_forward=1
                  │
                  │  NAT: oif "eno1" masquerade
                  │  FORWARD: ethusb0→eno1 允许
                  │           eno1→ethusb0 established/related 允许
                  └─────────▲─────────┘
                            │ (LAN) ethusb0
                            │  静态: 192.168.1.1/24
                            │  DHCP Server: 192.168.1.4-24
                            │  DNS: 192.168.1.1 或 8.8.8.8
                            │
            ┌───────────────┴────────────────┐
            │                                │
   Windows / 客户端 A                 客户端 B/手机 等
   DHCP: 192.168.1.22/24            DHCP: 192.168.1.x/24
   GW: 192.168.1.1                  GW: 192.168.1.1
```
## 配置
### 0. 硬件
```bash
eno1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.31.189  netmask 255.255.255.0  broadcast 192.168.31.255
        inet6 fe80::d2bf:9cff:fe85:a100  prefixlen 64  scopeid 0x20<link>
        ether d0:bf:9c:85:a1:00  txqueuelen 1000  (Ethernet)
        RX packets 577849  bytes 548976694 (523.5 MiB)
        RX errors 0  dropped 239  overruns 0  frame 0
        TX packets 540033  bytes 277101359 (264.2 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ethusb0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.1.1  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::2e16:dbff:feab:931  prefixlen 64  scopeid 0x20<link>
        ether 2c:16:db:ab:09:31  txqueuelen 1000  (Ethernet)
        RX packets 543204  bytes 271858258 (259.2 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 570809  bytes 554442400 (528.7 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 11521  bytes 9522588 (9.0 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 11521  bytes 9522588 (9.0 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```
| 接口    | 用途 | IP 地址        | 配置方式 | 备注                   |
| ------- | ---- | -------------- | -------- | ---------------------- |
| eno1    | WAN  | 192.168.31.189 | 动态IP   | DHCP客户端， 连接外网  |
| ethusb0 | LAN  | 192.168.1.1    | 静态IP   | DHCP服务器，分配内网IP |

### 1. systemd-networkd
#### 1.1 配置lan网络
```bash
# /etc/systemd/network/10-lan.network
[Match]
Name=ethusb0

[Network]
Address=192.168.1.1/24
DHCPServer=yes


[DHCPServer]
PoolOffset=4
PoolSize=20
EmitDNS=yes
EmitRouter=yes
DNS=114.114.114.114

```
#### 1.2 配置wan网络
```bash
# /etc/systemd/network/20-wan.network

[Match]
Name=eno1

[Network]
DHCP=yes

```
#### 配置usb网卡名字
```bash
# /etc/systemd/network/30-ethusb0.link

[Match]
MACAddress=2c:16:db:ab:09:31


[Link]
Description=USB to Ethernet Adapter
Name=ethusb0
```
### 2. Linux 内核允许转发
```bash
# /etc/sysctl.d/99-sysctl.conf

net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
```
### 3. nftables(防火墙)
- 开启必要端口(hdcp:67,68 ssh:22, icmp)
- 启用nat (ip 伪装)
```bash
# /etc/nftables.conf
destroy table inet filter
table inet filter {
  chain input {
    type filter hook input priority filter
    policy drop

    ct state invalid drop comment "early drop of invalid connections"
    ct state {established, related} accept comment "allow tracked connections"
    iif lo accept comment "allow from loopback"
    ip protocol icmp accept comment "allow icmp"
    meta l4proto ipv6-icmp accept comment "allow icmp v6"
    iif "ethusb0" udp dport {67,68} accept comment "allow DHCP server"
    tcp dport ssh accept comment "allow sshd"
    pkttype host limit rate 5/second counter reject with icmpx type admin-prohibited
    counter
  }
  chain forward {
    type filter hook forward priority filter
    policy drop
    iif "ethusb0" oif "eno1" accept comment "LAN -> WAN"
    iif "eno1" oif "ethusb0" ct state related,established accept comment "WAN -> LAN established"
    accept comment "fang xing suo you liu liang"
  }
}

table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100;
        oif "eno1" masquerade
    }
}
```
## 为什么用nat
LAN 子网（192.168.1.0/24）与 WAN 子网（192.168.31.0/24）没有路由可达 </br>

你的上级路由（192.168.31.1）只认识自己的 192.168.31.0/24。</br>

它不会知道“192.168.10.0/24 还在你这台 Linux 主机后面”，所以不会回包。</br>

NAT 可以把 192.168.1.x 的源 IP 改写成 192.168.31.150（eno1 地址），这样 WAN 路由器就能正常回包。</br>

不用 NAT 的条件

如果你能做到以下条件，就可以不用 NAT，直接做三层路由转发：

上级网关（192.168.31.1）支持配置静态路由。

在它上面加一条：

192.168.1.0/24 via 192.168.31.150


这样上级网关就知道要把 192.168.1.x 的包交给你的 Linux 网关。

## net.ipv4.ip_forward=1 具体作用
Linux 本身就是一个网络内核，可以扮演路由器。
默认情况下，Linux 不会转发一个接口收到的包到另一个接口 —— 也就是说，它不会主动帮 ethusb0 ↔ eno1 转发流量。

比如：

内网设备（192.168.1.22）发包 → 到达 Linux eno1 → 默认只会交给 Linux 本机，不会再转发到 ethusb0。

所以需要告诉内核：允许我作为路由器，把包在不同网口之间转发。

## 参考
- [Arch Linux 中文 Wiki: 网络分享](https://wiki.archlinuxcn.org/wiki/%E7%BD%91%E7%BB%9C%E5%88%86%E4%BA%AB)
- [systemd.network 中文手册](https://www.jinbuguo.com/systemd/systemd.network.html)
- [DHCP完整过程详解及Wireshark抓包分析](https://www.cnblogs.com/Wendy-r/p/12679241.html)
- [arch linux 添加路由,将你的Archlinux打造成路由器](https://blog.csdn.net/weixin_30199835/article/details/116838432)
- [测网速 speedtest](https://www.speedtest.net/zh-Hans/result/18104727511)
